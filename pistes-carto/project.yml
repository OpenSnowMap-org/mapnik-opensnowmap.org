bounds: &world
    - -180
    - -85.0511
    - 180
    - 85.0511
  
center: 
    - 6.0928
    - 46.4319
    - 16
format: png24
interactivity: false
minzoom: 0
maxzoom: 18
srs: "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over"
scale: 1
metatile: 8
attribution: "Data © OpenStreetMap (and) contributors, OdBL; map (c) Opensnowmap.org, CC-BY-SA"
description: ""
name: pistes-carto

Stylesheet:
    - ../fonts-carto/fonts.mss
    - base.mss
    - others.mss
    - pistes.mss
    - downhill.mss
    - nordic.mss
    - aerialways.mss
    - routes_simples.mss
    - sites.mss

# Various parts to be included later on
_parts:
  # Extents are used for tilemill, and don't actually make it to the generated XML
  extents: &extents
    extent: *world
    srs-name: "900913"
    srs: "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over"
  extents84: &extents84
    extent: *world
    srs-name: "WGS84"
    srs: "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
  imposm: &imposm
    type: "postgis"
    dbname: "pistes_imposm"
    user: "imposm"
    key_field: ""
    geometry_field: ""
    extent: "-20037508,-20037508,20037508,20037508"

Layer:
    ## skitour ##
    - id: skitour-routes
      geometry: geometry
      class: skitour
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming ,
                (case 
                    when (ST_X(ST_centroid(geometry)) > -4000000 or ST_y(ST_centroid(geometry)) < 0)
                    then '0' 
                    else '1' 
                end) as us
                from pistes_routes 
                where 
                (piste_type LIKE '%skitour%'
                or (piste_type LIKE '%downhill%' and grooming='backcountry'))
                and not (abandoned1 or abandoned2)
                ) as pistes
      properties:
        minzoom: 9
    
    - id: skitour-eraser
      # erase relations already rendered, otherwise dashs looks ugly
      geometry: geometry
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming from osm_pistes_ways 
                where 
                (piste_type LIKE '%skitour%'
                or (piste_type LIKE '%downhill%' and grooming='backcountry'))
                and not (abandoned1 or abandoned2)
                ) as pistes
      properties:
        minzoom: 9
        
    - id: skitour
      # erase relations already rendered, otherwise dashs looks ugly
      geometry: geometry
      class: skitour
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming ,
                (case 
                    when (ST_X(ST_centroid(geometry)) > -4000000 or ST_y(ST_centroid(geometry)) < 0)
                    then '0' 
                    else '1' 
                end) as us
                from osm_pistes_ways 
                where 
                (piste_type LIKE '%skitour%'
                or (piste_type LIKE '%downhill%' and grooming='backcountry'))
                and not (abandoned1 or abandoned2)
                ) as pistes
      properties:
        minzoom: 9
    
    - id: various-areas
      geometry: polygon
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-                
                (select geometry, piste_type, grooming from osm_pistes_area
                where 
                (piste_type LIKE '%ice_skate%' 
                or piste_type LIKE '%playground%' 
                or piste_type LIKE '%sled%' 
                or piste_type LIKE '%ski_jump%' 
                or piste_type LIKE '%snow_park%' 
                or piste_type LIKE '%sleigh%' 
                or piste_type LIKE '%hike%'
                or piste_type LIKE '%skitour%'
                or (piste_type LIKE '%downhill%' and grooming='backcountry'))
                and not (abandoned1 or abandoned2)
                
                ) as pistes
      properties:
        minzoom: 9
    ## DOWNHILL ##
    - id: downhill-bg
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming 
                from osm_pistes_ways
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                UNION
                
                select geometry, difficulty, grooming 
                from pistes_routes
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                ) as pistes
      properties:
        minzoom: 9
        
    - id: downhill-casing
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (
                (select 0 as ord, geometry, difficulty, grooming ,
                (case 
                    when (ST_X(ST_centroid(geometry)) > -4000000 or ST_y(ST_centroid(geometry)) < 0)
                    then '0' 
                    else '1' 
                end) as us
                from osm_pistes_ways
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                )
                
                UNION
                
                (select 1 as ord, geometry, difficulty, grooming ,
                (case 
                    when (ST_X(ST_centroid(geometry)) > -4000000 or ST_y(ST_centroid(geometry)) < 0)
                    then '0' 
                    else '1' 
                end) as us
                from pistes_routes
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                )
                ORDER BY ord DESC
                ) as pistes
      properties:
        minzoom: 9
        
    - id: downhill-area-bg
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming from osm_pistes_area 
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                and not (abandoned1 or abandoned2)
                ) as pistes
      properties:
        minzoom: 9
        
    - id: downhill-area-casing
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming ,
                (case 
                    when (ST_X(ST_centroid(geometry)) > -4000000 or ST_y(ST_centroid(geometry)) < 0)
                    then '0' 
                    else '1' 
                end) as us
                from osm_pistes_area 
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                and not (abandoned1 or abandoned2)
                ) as pistes
      properties:
        minzoom: 9
        
    - id: downhill-overlay-eraser1
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming from osm_pistes_ways 
                where 
                piste_type LIKE '%downhill%'
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                UNION
                
                select geometry, difficulty, grooming from pistes_routes 
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                ) as pistes
      properties:
        minzoom: 9
    - id: downhill-overlay-eraser2
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming from osm_pistes_ways 
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                UNION
                
                select geometry, difficulty, grooming from pistes_routes 
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                ) as pistes
      properties:
        minzoom: 9
    - id: downhill-overlay-eraser3
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming from osm_pistes_ways 
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                UNION
                
                select geometry, difficulty, grooming from pistes_routes 
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                ) as pistes
      properties:
        minzoom: 9
    
    - id: downhill-overlay-eraser4
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming from osm_pistes_ways 
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                UNION
                
                select geometry, difficulty, grooming from pistes_routes 
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                ) as pistes
      properties:
        minzoom: 9
        
        
    - id: downhill-area-eraser
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming from osm_pistes_area 
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                and not (abandoned1 or abandoned2)
                ) as pistes
      properties:
        minzoom: 9
        
        
    - id: downhill-area-fill
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming ,
                (case 
                    when (ST_X(ST_centroid(geometry)) > -4000000 or ST_y(ST_centroid(geometry)) < 0)
                    then '0' 
                    else '1' 
                end) as us
                from osm_pistes_area
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                and not (abandoned1 or abandoned2)
                ) as pistes
      properties:
        minzoom: 9
        
    - id: downhill-overlay-thin 
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (
                (select 0 as ord, geometry, difficulty, grooming ,
                (case 
                    when (ST_X(ST_centroid(geometry)) > -4000000 or ST_y(ST_centroid(geometry)) < 0)
                    then '0' 
                    else '1' 
                end) as us
                from osm_pistes_ways
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                )
                
                UNION
                
                (select 1 as ord, geometry, difficulty, grooming ,
                (case 
                    when (ST_X(ST_centroid(geometry)) > -4000000 or ST_y(ST_centroid(geometry)) < 0)
                    then '0' 
                    else '1' 
                end) as us
                from pistes_routes
                where 
                (piste_type LIKE '%downhill%' and (grooming not in ('backcountry') or grooming is null))
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                )
                ORDER BY ord DESC
                ) as pistes
      properties:
        minzoom: 9
        
    ## OTHERS ##
    ## SNOWSHOEING ##
    - id: snowshoeing-routes
      geometry: geometry
      class: snowshoeing
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming from pistes_routes 
                where 
                piste_type LIKE '%hike%'
                and not (abandoned1 or abandoned2)
                ) as pistes
      properties:
        minzoom: 9
    
    - id: snowshoeing-eraser
      # erase relations already rendered, otherwise dashs looks ugly
      geometry: geometry
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming from osm_pistes_ways 
                where 
                piste_type LIKE '%hike%'
                and not (abandoned1 or abandoned2)
                ) as pistes
      properties:
        minzoom: 9
        
    - id: snowshoeing
      # erase relations already rendered, otherwise dashs looks ugly
      geometry: geometry
      class: snowshoeing
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming from osm_pistes_ways 
                where 
                piste_type LIKE '%hike%'
                and not (abandoned1 or abandoned2)
                ) as pistes
      properties:
        minzoom: 9
    
    ## VARIOUS ##
    - id: various-ways
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, piste_type from osm_pistes_ways 
                where 
                ( piste_type LIKE '%ice_skate%' 
                or piste_type LIKE '%playground%' 
                or piste_type LIKE '%sled%' 
                or piste_type LIKE '%ski_jump%' 
                or piste_type LIKE '%snow_park%' 
                or piste_type LIKE '%sleigh%' 
                or piste_type LIKE '%hike%')
                and not (abandoned1 or abandoned2)
                AND geometry && !bbox!
                
                UNION
                
                select geometry, piste_type from pistes_routes 
                where 
                ( piste_type LIKE '%ice_skate%' 
                or piste_type LIKE '%playground%' 
                or piste_type LIKE '%sled%' 
                or piste_type LIKE '%ski_jump%' 
                or piste_type LIKE '%snow_park%' 
                or piste_type LIKE '%sleigh%' 
                or piste_type LIKE '%hike%')
                and not (abandoned1 or abandoned2)
                AND geometry && !bbox!
                
                UNION
                
                select geometry, piste_type from osm_sport_ways 
                where 
                ( piste_type LIKE '%skating%'
                or piste_type LIKE '%ski_jump%'
                or piste_type LIKE '%ice_skating%'
                or piste_type LIKE '%ice_hockey%'
                or piste_type LIKE '%curling%'
                or piste_type LIKE '%ice_stock%')
                AND geometry && !bbox!
                
                UNION
                
                select geometry, piste_type from osm_sport_nodes 
                where 
                ( piste_type LIKE '%skating%'
                or piste_type LIKE '%ski_jump%'
                or piste_type LIKE '%ice_skating%'
                or piste_type LIKE '%ice_hockey%'
                or piste_type LIKE '%curling%'
                or piste_type LIKE '%ice_stock%')
                AND geometry && !bbox!
                
                ) as pistes
      properties:
        minzoom: 9
        
    ## NORDIC ##
    - id: nordic-bg
      geometry: linestring
      class: nordic-bg
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
          (SELECT 
            geometry, 0 as nordic_route_offset, nordic_route_render_colour, 1 as direction_to_route
            FROM 
            osm_pistes_ways
            WHERE
            piste_type like '%nordic%'
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
            AND osm_id NOT IN (
                SELECT member
                FROM osm_pistes_route_members
                WHERE piste_type like '%nordic%'
                AND geometry && !bbox!
            )
            
            UNION
            
            SELECT 
            geometry, 0 as nordic_route_offset, '' as nordic_route_render_colour, 1 as direction_to_route
            FROM 
            osm_pistes_area
            WHERE
            piste_type like '%nordic%'
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
            AND osm_id NOT IN (
                SELECT member
                FROM osm_pistes_route_members
                WHERE piste_type like '%nordic%'
                AND geometry && !bbox!
            )
            
            UNION
            
            SELECT 
            geometry, nordic_route_offset, nordic_route_render_colour, direction_to_route
            FROM 
            osm_pistes_route_members
            WHERE
            piste_type like '%nordic%'
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
          ) as data
      properties:
        minzoom: 9
        
    - id: nordic-difficulty-bg
      geometry: linestring
      #~ class: nordic-bg
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
          (SELECT 
            geometry, 0 as nordic_route_offset, nordic_route_render_colour, 1 as direction_to_route
            FROM 
            osm_pistes_ways
            WHERE
            piste_type like '%nordic%'
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
            AND difficulty IN ('intermediate', 'advanced', 'expert', 'freeride','extreme')
            AND osm_id NOT IN (
                SELECT member
                FROM osm_pistes_route_members
                WHERE piste_type like '%nordic%'
                AND geometry && !bbox!
            )
            
            UNION
            
            SELECT 
            geometry, 0 as nordic_route_offset, '' as nordic_route_render_colour, 1 as direction_to_route
            FROM 
            osm_pistes_area
            WHERE
            piste_type like '%nordic%'
            AND difficulty IN ('intermediate', 'advanced', 'expert', 'freeride','extreme')
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
            AND osm_id NOT IN (
                SELECT member
                FROM osm_pistes_route_members
                WHERE piste_type like '%nordic%'
                AND geometry && !bbox!
            )
            UNION
            
            SELECT 
            geometry, nordic_route_offset, nordic_route_render_colour, direction_to_route
            FROM 
            osm_pistes_route_members
            WHERE
            piste_type like '%nordic%'
            AND difficulty IN ('intermediate', 'advanced', 'expert', 'freeride','extreme')
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
          ) as data
      properties:
        minzoom: 9
        
        
    - id: nordic-way-fadein
      geometry: linestring
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
            (SELECT st_collect(geometry) as geometry
            FROM
              (SELECT 
                geometry
                FROM 
                osm_pistes_ways
                WHERE
                piste_type like '%nordic%'
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                AND osm_id NOT IN (
                    SELECT member
                    FROM osm_pistes_route_members
                    WHERE piste_type like '%nordic%'
                    AND geometry && !bbox!
                )
                
                UNION
                
                SELECT 
                geometry
                FROM 
                osm_pistes_area
                WHERE
                piste_type like '%nordic%'
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                AND osm_id NOT IN (
                    SELECT member
                    FROM osm_pistes_route_members
                    WHERE piste_type like '%nordic%'
                    AND geometry && !bbox!
                )
                
                UNION
                
                SELECT 
                geometry
                FROM 
                pistes_routes
                WHERE
                piste_type like '%nordic%'
                and not (abandoned1 or abandoned2)
                AND geometry && !bbox!
              ) as lines
            ) as data
      properties:
        minzoom: 9
    - id: nordic-way 
      geometry: linestring
      class: nordic-way
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
            (SELECT geometry,
            nordic_route_offset, nordic_route_render_colour, direction_to_route,
            grooming, ST_Length(geometry) as length
            FROM
              (SELECT 
                geometry, 0 as nordic_route_offset, nordic_route_render_colour, 1 as direction_to_route,
                grooming
                FROM 
                osm_pistes_ways
                WHERE
                piste_type like '%nordic%'
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                AND osm_id NOT IN (
                    SELECT member
                    FROM osm_pistes_route_members
                    WHERE piste_type like '%nordic%'
                    AND geometry && !bbox!
                )
                
                UNION
                
                SELECT 
                geometry, 0 as nordic_route_offset, '' as nordic_route_render_colour, 1 as direction_to_route,
                grooming
                FROM 
                osm_pistes_area
                WHERE
                piste_type like '%nordic%'
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                AND osm_id NOT IN (
                    SELECT member
                    FROM osm_pistes_route_members
                    WHERE piste_type like '%nordic%'
                    AND geometry && !bbox!
                )
                
                UNION
                
                SELECT 
                geometry, nordic_route_offset, nordic_route_render_colour, 1 as direction_to_route,
                grooming
                FROM 
                pistes_routes
                WHERE
                piste_type like '%nordic%'
                and not (abandoned1 or abandoned2)
                AND geometry && !bbox!
                
                
              ) as lines
            ORDER BY length DESC
            ) as data
      properties:
        minzoom: 12

    - id: nordic-grooming
      geometry: linestring
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
          (SELECT 
            geometry, 0 as nordic_route_offset, nordic_route_render_colour, 1 as direction_to_route,
            grooming
            FROM 
            osm_pistes_ways
            WHERE
            piste_type like '%nordic%'
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
            AND osm_id NOT IN (
                SELECT member
                FROM osm_pistes_route_members
                WHERE piste_type like '%nordic%'
                AND geometry && !bbox!
            )
            
            UNION
            
            SELECT 
            geometry, 0 as nordic_route_offset, '' as nordic_route_render_colour, 1 as direction_to_route,
            grooming
            FROM 
            osm_pistes_area
            WHERE
            piste_type like '%nordic%'
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
            AND osm_id NOT IN (
                SELECT member
                FROM osm_pistes_route_members
                WHERE piste_type like '%nordic%'
                AND geometry && !bbox!
            )
            UNION
            
            SELECT 
            geometry, nordic_route_offset, nordic_route_render_colour, direction_to_route,
            grooming
            FROM 
            osm_pistes_route_members
            WHERE
            piste_type like '%nordic%'
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
          ) as data
      properties:
        minzoom: 9

    - id: nordic-no-difficulty-no-grooming
      geometry: linestring
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
          (SELECT 
            geometry, 0 as nordic_route_offset, nordic_route_render_colour, 1 as direction_to_route
            FROM 
            osm_pistes_ways
            WHERE
            piste_type like '%nordic%'
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
            AND 
                (difficulty NOT IN ('novice', 'easy', 'intermediate', 'advanced', 'expert', 'freeride','extreme')
                OR
                grooming ='')
            AND osm_id NOT IN (
                SELECT member
                FROM osm_pistes_route_members
                WHERE piste_type like '%nordic%'
                AND geometry && !bbox!
            )
            
            UNION
            
            SELECT 
            geometry, 0 as nordic_route_offset, '' as nordic_route_render_colour, 1 as direction_to_route
            FROM 
            osm_pistes_area
            WHERE
            piste_type like '%nordic%'
            AND 
                (difficulty NOT IN ('novice', 'easy', 'intermediate', 'advanced', 'expert', 'freeride','extreme')
                OR
                grooming ='')
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
            AND osm_id NOT IN (
                SELECT member
                FROM osm_pistes_route_members
                WHERE piste_type like '%nordic%'
                AND geometry && !bbox!
            )
                        UNION
            
            SELECT 
            geometry, nordic_route_offset, nordic_route_render_colour, direction_to_route
            FROM 
            osm_pistes_route_members
            WHERE
            piste_type like '%nordic%'
            AND 
                (difficulty NOT IN ('novice', 'easy', 'intermediate', 'advanced', 'expert', 'freeride','extreme')
                OR
                grooming ='')
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
            
          ) as data
      properties:
        minzoom: 9

       
    - id: nordic-difficulty-markers
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
         (SELECT 
            geometry, difficulty
            FROM 
            osm_pistes_ways
            WHERE
            piste_type like '%nordic%'
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
            and difficulty in ('intermediate', 'advanced', 'expert', 'freeride','extreme')
            
            UNION
            
            SELECT 
            geometry, difficulty
            FROM 
            osm_pistes_area
            WHERE
            piste_type like '%nordic%'
            and not (abandoned1 or abandoned2)
            and difficulty in ('intermediate', 'advanced', 'expert', 'freeride','extreme')
            AND geometry && !bbox!
            
          ) as data
      properties:
        minzoom: 9
        
    - id: nordic-grooming-icons
      geometry: linestring
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
          (SELECT 
            geometry, 0 as nordic_route_offset, nordic_route_render_colour, 1 as direction_to_route,
            grooming
            FROM 
            osm_pistes_ways
            WHERE
            piste_type like '%nordic%'
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
            AND osm_id NOT IN (
                SELECT member
                FROM osm_pistes_route_members
                WHERE piste_type like '%nordic%'
                AND geometry && !bbox!
            )
            
            UNION
            
            SELECT 
            geometry, 0 as nordic_route_offset, '' as nordic_route_render_colour, 1 as direction_to_route,
            grooming
            FROM 
            osm_pistes_area
            WHERE
            piste_type like '%nordic%'
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
            AND osm_id NOT IN (
                SELECT member
                FROM osm_pistes_route_members
                WHERE piste_type like '%nordic%'
                AND geometry && !bbox!
            )
            UNION
            
            SELECT 
            geometry, nordic_route_offset, nordic_route_render_colour, direction_to_route,
            grooming
            FROM 
            osm_pistes_route_members
            WHERE
            piste_type like '%nordic%'
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
          ) as data
      properties:
        minzoom: 9


    ## AERIALWAYS ##
    - id: aerialways
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
          (SELECT 
            geometry, piste_type, name
          FROM 
            osm_aerialways
            WHERE geometry && !bbox!
            and not (abandoned1 or abandoned2)
          
          ) as data
      properties:
        minzoom: 9
        
    # azimuth doesn't work anymore the same ??
    - id: aerialways-icons
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
          (SELECT 
             piste_type, name,
            (CASE 
                WHEN st_x(st_startpoint(geometry)) < st_x(st_endpoint(geometry))
                THEN geometry 
                ELSE st_reverse(geometry)
            END) as geometry
          FROM 
            osm_aerialways
          WHERE 
            not (abandoned1 or abandoned2)
          ) as data
      properties:
        minzoom: 9
    
    # Various markers
    - id: lit
      geometry: geometry
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
          (SELECT 
            geometry
          FROM 
            osm_pistes_ways
          WHERE
            lit1 or lit2
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
            
          UNION
          
          SELECT 
            geometry
          FROM 
            osm_pistes_area
          WHERE
            lit1 or lit2
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
          ) as data
      properties:
        minzoom: 9
        
    - id: downhill-icons
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, difficulty, grooming, (lit1 or lit2) as lit, gladed,
                (case 
                    when (ST_X(ST_centroid(geometry)) > -4000000 or ST_y(ST_centroid(geometry)) < 0)
                    then '0' 
                    else '1' 
                end) as us
                from osm_pistes_ways
                where 
                piste_type LIKE '%downhill%' and (grooming='mogul' or gladed=true or lit1=true or lit2=true or difficulty='freeride')
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                UNION
                
                select geometry, difficulty, grooming, (lit1 or lit2) as lit, gladed,
                (case 
                    when (ST_X(ST_centroid(geometry)) > -4000000 or ST_y(ST_centroid(geometry)) < 0)
                    then '0' 
                    else '1' 
                end) as us
                from pistes_routes
                where 
                piste_type LIKE '%downhill%' and (grooming='mogul' or gladed=true or lit1=true or lit2=true or difficulty='freeride')
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                ) as pistes
      properties:
        minzoom: 9
    
    # Texts
    - id: downhill-text
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
            (SELECT geometry, difficulty, grooming, lit, gladed, us, 
            CASE 
                WHEN n is not null and r is null
                    THEN n
                WHEN n is null and r is not null
                    THEN r
                WHEN r=n
                    THEN n
                WHEN n is not null and r is not null
                    THEN concat(r,' - ',n)
            END as pistename
            
            FROM(
                    SELECT geometry, difficulty, grooming, 
                    coalesce(NULLIF(piste_name,''), NULLIF(name,'')) as n,
                    coalesce(NULLIF(piste_ref,''), NULLIF(ref,'')) as r,
                    (lit1 or lit2) as lit,
                    gladed,
                    (CASE 
                        WHEN (ST_X(ST_centroid(geometry)) > -4000000 or ST_y(ST_centroid(geometry)) < 0)
                        THEN '0' 
                        ELSE '1' 
                    END) as us
                    FROM osm_pistes_ways
                    WHERE 
                        piste_type LIKE '%downhill%' 
                        AND geometry && !bbox!
                        AND (piste_name!='' or name!='' or piste_ref!='' or ref!='' )
                        and not (abandoned1 or abandoned2)
                    
                    UNION
                    
                    SELECT geometry, difficulty, grooming, 
                    coalesce(NULLIF(piste_name,''), NULLIF(name,'')) as n, 
                    coalesce(NULLIF(piste_ref,''), NULLIF(ref,'')) as r,
                    (lit1 or lit2) as lit, 
                    gladed,
                    (CASE 
                        WHEN (ST_X(ST_centroid(geometry)) > -4000000 or ST_y(ST_centroid(geometry)) < 0)
                        THEN '0' 
                        ELSE '1' 
                    END) as us
                    FROM pistes_routes
                    WHERE 
                        piste_type LIKE '%downhill%' 
                        AND geometry && !bbox!
                        AND (piste_name!='' or name!='' or piste_ref!='' or ref!='' )
                        and not (abandoned1 or abandoned2)
                    
                    UNION
                    
                    SELECT geometry, difficulty, grooming, 
                    coalesce(NULLIF(piste_name,''), NULLIF(name,'')) as n, 
                    coalesce(NULLIF(piste_ref,''), NULLIF(ref,'')) as r,
                    (lit1 or lit2) as lit, 
                    gladed,
                    (CASE 
                        WHEN (ST_X(ST_centroid(geometry)) > -4000000 or ST_y(ST_centroid(geometry)) < 0)
                        THEN '0' 
                        ELSE '1' 
                    END) as us
                    FROM osm_pistes_area
                    WHERE 
                        piste_type LIKE '%downhill%' 
                        AND geometry && !bbox!
                        AND (piste_name!='' or name!='' or piste_ref!='' or ref!='' )
                        and not (abandoned1 or abandoned2)
                
                ) as data
            ) as pistes
      properties:
        minzoom: 9
        
    - id: aerialways-text
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
          (SELECT geometry, piste_type, 
            CASE 
                WHEN n is not null and r is null
                    THEN n
                WHEN n is null and r is not null
                    THEN r
                WHEN r=n
                    THEN n
                WHEN n is not null and r is not null
                    THEN concat(r,' - ',n)
            END as name
          FROM (
              SELECT geometry, piste_type, name as n, ref as r
              FROM
                osm_aerialways
                WHERE 
                not (abandoned1 or abandoned2)
              ORDER BY
                st_length(geometry) desc
              ) as data
          ) as pistes
      properties:
        minzoom: 9
    - id: sites
      geometry: polygon
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
          (
          SELECT distinct on (geometry) 
          
          --get only the first result, even for the 3 mapping of 'les trois or 3 Vallées', snaptogrid is needed too
          
            geometry, name, piste_type, osm_id,
            downhill, nordic, sled, hike, snowpark, jump, playground, skitour, skat, sleigh,
            cnt
          FROM
          (
              (SELECT 
                ST_SnapToGrid(st_centroid(geometry),3000) as geometry,
                name as name, members_types as piste_type, osm_id,
                members_types~'downhill' as downhill,
                members_types~'nordic' as nordic,
                members_types~'sled' as sled,
                members_types~'hike' as hike,
                members_types~'snow_park' as snowpark,
                members_types~'jump' as jump,
                members_types~'playground' as playground,
                members_types~'skitour' as skitour,
                members_types~'skat' as skat,
                members_types~'sleigh' as sleigh,
                array_length(array(select distinct unnest(string_to_array(members_types,';'))),1) as cnt
              FROM 
                pistes_sites
              WHERE geometry && !bbox!
              )
              
              UNION
              (SELECT 
                ST_SnapToGrid(st_centroid(geometry),3000) as geometry,
                name as name, members_types as piste_type, osm_id,
                members_types~'downhill' as downhill,
                members_types~'nordic' as nordic,
                members_types~'sled' as sled,
                members_types~'hike' as hike,
                members_types~'snow_park' as snowpark,
                members_types~'jump' as jump,
                members_types~'playground' as playground,
                members_types~'skitour' as skitour,
                members_types~'skat' as skat,
                members_types~'sleigh' as sleigh,
                array_length(array(select distinct unnest(string_to_array(members_types,';'))),1) as cnt
              FROM 
                landuse_resorts
              WHERE ST_Area(geometry)>500000
              AND geometry && !bbox!
              )
              
              ORDER BY cnt DESC
              
            ) as resorts
          ) as data
      properties:
        minzoom: 9
    
    
    - id: nordic-text
      geometry: linestring
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
            (SELECT 
            geometry, 0 as nordic_route_offset, nordic_route_render_colour, 1 as direction_to_route,
            coalesce(NULLIF(piste_name,''), NULLIF(name,'')) as name
            FROM 
            osm_pistes_ways
            WHERE
            piste_type like '%nordic%'
            AND geometry && !bbox!
            AND osm_id NOT IN (
                SELECT member
                FROM osm_pistes_route_members
                WHERE piste_type like '%nordic%'
                AND geometry && !bbox!
                 and not (abandoned1 or abandoned2)
            )
            
            UNION
            
            SELECT 
            geometry, 0 as nordic_route_offset, '' as nordic_route_render_colour, 1 as direction_to_route,
            coalesce(NULLIF(piste_name,''), NULLIF(name,'')) as name
            FROM 
            osm_pistes_area
            WHERE
            piste_type like '%nordic%'
            AND geometry && !bbox!
            AND osm_id NOT IN (
                SELECT member
                FROM osm_pistes_route_members
                WHERE piste_type like '%nordic%'
                AND geometry && !bbox!
                 and not (abandoned1 or abandoned2)
            )
            
            UNION
            
            SELECT 
            geometry, nordic_route_offset, nordic_route_render_colour, 1 as direction_to_route,
            coalesce(NULLIF(piste_name,''), NULLIF(name,'')) as name
            FROM 
            pistes_routes
            WHERE
            piste_type like '%nordic%'
            AND geometry && !bbox!
            and not (abandoned1 or abandoned2)
            
            ) as data
      properties:
        minzoom: 9
    - id: various-icons
      geometry: geometry
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, piste_type from osm_pistes_ways 
                where 
                ( piste_type LIKE '%ice_skate%' 
                or piste_type LIKE '%playground%' 
                or piste_type LIKE '%sled%' 
                or piste_type LIKE '%ski_jump%' 
                or piste_type LIKE '%snow_park%' 
                or piste_type LIKE '%sleigh%' 
                or piste_type LIKE '%hike%'
                or piste_type LIKE '%skitour%'
                or (piste_type LIKE '%downhill%' and grooming='backcountry')
                )
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                UNION
                
                select geometry, piste_type from osm_pistes_area
                where 
                ( piste_type LIKE '%ice_skate%' 
                or piste_type LIKE '%playground%' 
                or piste_type LIKE '%sled%' 
                or piste_type LIKE '%ski_jump%' 
                or piste_type LIKE '%snow_park%' 
                or piste_type LIKE '%sleigh%' 
                or piste_type LIKE '%hike%'
                )
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                UNION
                
                select geometry, piste_type from pistes_routes 
                where 
                ( piste_type LIKE '%ice_skate%' 
                or piste_type LIKE '%playground%' 
                or piste_type LIKE '%sled%' 
                or piste_type LIKE '%ski_jump%' 
                or piste_type LIKE '%snow_park%' 
                or piste_type LIKE '%sleigh%' 
                or piste_type LIKE '%hike%'
                or piste_type LIKE '%skitour%'
                or (piste_type LIKE '%downhill%' and grooming='backcountry')
                )
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                UNION
                
                select geometry, piste_type from osm_sport_ways 
                where 
                ( piste_type LIKE '%skating%'
                or piste_type LIKE '%ski_jump%'
                or piste_type LIKE '%ice_skating%'
                or piste_type LIKE '%ice_hockey%'
                or piste_type LIKE '%curling%'
                or piste_type LIKE '%ice_stock%')
                AND geometry && !bbox!
                
                UNION
                
                select geometry, piste_type from osm_sport_nodes 
                where 
                ( piste_type LIKE '%skating%'
                or piste_type LIKE '%ski_jump%'
                or piste_type LIKE '%ice_skating%'
                or piste_type LIKE '%ice_hockey%'
                or piste_type LIKE '%curling%'
                or piste_type LIKE '%ice_stock%')
                AND geometry && !bbox!
                
                ) as pistes
      properties:
        minzoom: 9
    - id: various-text
      geometry: geometry
      class: ''
      <<: *extents
      Datasource:
        <<: *imposm
        table: |-
                (select geometry, piste_type,
                coalesce(NULLIF(piste_name,''), NULLIF(name,'')) as name
                from osm_pistes_ways 
                where 
                ( piste_type LIKE '%ice_skate%' 
                or piste_type LIKE '%playground%' 
                or piste_type LIKE '%sled%' 
                or piste_type LIKE '%ski_jump%' 
                or piste_type LIKE '%snow_park%' 
                or piste_type LIKE '%sleigh%' 
                or piste_type LIKE '%hike%'
                or piste_type LIKE '%skitour%')
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                UNION
                
                select geometry, piste_type,
                coalesce(NULLIF(piste_name,''), NULLIF(name,'')) as name
                from osm_pistes_area
                where 
                ( piste_type LIKE '%ice_skate%' 
                or piste_type LIKE '%playground%' 
                or piste_type LIKE '%sled%' 
                or piste_type LIKE '%ski_jump%' 
                or piste_type LIKE '%snow_park%' 
                or piste_type LIKE '%sleigh%' 
                or piste_type LIKE '%hike%'
                or piste_type LIKE '%skitour%')
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                UNION
                
                select geometry, piste_type,
                coalesce(NULLIF(piste_name,''), NULLIF(name,'')) as name
                from pistes_routes 
                where 
                ( piste_type LIKE '%ice_skate%' 
                or piste_type LIKE '%playground%' 
                or piste_type LIKE '%sled%' 
                or piste_type LIKE '%ski_jump%' 
                or piste_type LIKE '%snow_park%' 
                or piste_type LIKE '%sleigh%' 
                or piste_type LIKE '%hike%'
                or piste_type LIKE '%skitour%')
                AND geometry && !bbox!
                and not (abandoned1 or abandoned2)
                
                UNION
                
                select geometry, piste_type,
                coalesce(NULLIF(name,'')) as name
                from osm_sport_ways 
                where 
                ( piste_type LIKE '%skating%'
                or piste_type LIKE '%ski_jump%'
                or piste_type LIKE '%ice_skating%'
                or piste_type LIKE '%ice_hockey%'
                or piste_type LIKE '%curling%'
                or piste_type LIKE '%ice_stock%')
                AND geometry && !bbox!
                
                UNION
                
                select geometry, piste_type,
                coalesce(NULLIF(name,'')) as name
                from osm_sport_nodes 
                where 
                ( piste_type LIKE '%skating%'
                or piste_type LIKE '%ski_jump%'
                or piste_type LIKE '%ice_skating%'
                or piste_type LIKE '%ice_hockey%'
                or piste_type LIKE '%curling%'
                or piste_type LIKE '%ice_stock%')
                AND geometry && !bbox!
                
                ) as pistes
      properties:
        minzoom: 9
        

